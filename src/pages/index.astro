---
export const prerender = false;

import Base from "../layouts/Base.astro";

import heroDefault from "../data/hero.json";
import ctaDefault from "../data/cta.json";

import Header from "../components/Header.astro";
import Hero from "../components/home/Hero.astro";
import UnlimitedSupport from "../components/home/UnlimitedSupport.astro";
import WhyChoose from "../components/home/WhyChoose.astro";
import Testimonials from "../components/home/Testimonials.astro";
import ImageBand from "../components/home/ImageBand.astro";
import FinalCTA from "../components/home/FinalCTA.astro";
import Footer from "../components/Footer.astro";

type HeroContent = typeof heroDefault;
type CtaContent = typeof ctaDefault;

const env = Astro.locals?.runtime?.env ?? {};

async function readKVOrDefault<T>(key: string, fallback: T): Promise<T> {
  if (!env.CONTENT_KV) return fallback;
  const raw = await env.CONTENT_KV.get(`${key}.json`);
  if (!raw) return fallback;
  try { return JSON.parse(raw) as T; } catch { return fallback; }
}

const hero = await readKVOrDefault<HeroContent>("hero", heroDefault);
const cta  = await readKVOrDefault<CtaContent>("cta", ctaDefault);
---

<Base>
  <Header />

  <main>
    <Hero data={hero} />
    <UnlimitedSupport />
    <WhyChoose />
    <Testimonials />
    <ImageBand />
    <FinalCTA data={cta} />
  </main>

  <Footer />
</Base>